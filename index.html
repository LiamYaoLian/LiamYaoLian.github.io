<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.1.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"liamyaolian.github.io","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Liam Lian&#39;s Blog">
<meta property="og:url" content="https://liamyaolian.github.io/index.html">
<meta property="og:site_name" content="Liam Lian&#39;s Blog">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Liam Lian">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://liamyaolian.github.io/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>Liam Lian's Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Liam Lian's Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://liamyaolian.github.io/2022/12/08/Multi-Thread-Summry/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Liam Lian">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Liam Lian's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/12/08/Multi-Thread-Summry/" class="post-title-link" itemprop="url">Multi-Thread Summary</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-12-08 17:25:15" itemprop="dateCreated datePublished" datetime="2022-12-08T17:25:15-05:00">2022-12-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-12-10 20:00:39" itemprop="dateModified" datetime="2022-12-10T20:00:39-05:00">2022-12-10</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java-fundamental/" itemprop="url" rel="index"><span itemprop="name">Java fundamental</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Thread"><a href="#Thread" class="headerlink" title="Thread"></a>Thread</h1><ul>
<li>every thread has its own method-call stack. Calculate parameters first, push parameters to method-call stack, and then execute method body<br><img src="/../image/multi-thread/CPU_cache.webp" alt="CPU cache"></li>
</ul>
<h1 id="Frequently-Used-Methods"><a href="#Frequently-Used-Methods" class="headerlink" title="Frequently-Used Methods"></a>Frequently-Used Methods</h1><h2 id="Runnable"><a href="#Runnable" class="headerlink" title="Runnable"></a>Runnable</h2><ul>
<li>void run()<h2 id="Thread-implements-Runnable"><a href="#Thread-implements-Runnable" class="headerlink" title="Thread implements Runnable"></a>Thread implements Runnable</h2></li>
<li>constructors<ul>
<li>Thread()</li>
<li>Thread(Runnable target)</li>
<li>Thread(Runnable target, String name)</li>
<li>Thread(String name)</li>
</ul>
</li>
<li>void start()  </li>
<li>void run()<ul>
<li><a target="_blank" rel="noopener" href="https://www.geeksforgeeks.org/difference-between-thread-start-and-thread-run-in-java/#:~:text=Multiple%20invocation%3A%20In%20Java&#39;s%20multi,just%20a%20normal%20method%20calling">https://www.geeksforgeeks.org/difference-between-thread-start-and-thread-run-in-java/#:~:text=Multiple%20invocation%3A%20In%20Java&#39;s%20multi,just%20a%20normal%20method%20calling</a>.</li>
</ul>
</li>
<li>void join(), void join(milliseconds)</li>
<li>static void sleep(long millis)</li>
<li>static void yield()<ul>
<li>A hint to the scheduler that the current thread is willing to yield its current use of a processor.</li>
</ul>
</li>
<li>void interrupt()<ul>
<li><code>threadToBeInterrupted.interrupt()</code></li>
<li>t.interrupt() will set interrupt status be to true.</li>
<li>after being interrupted, usually the thread will throw InterruptedException. Need to determine how to handle that. Throwing InterruptedException will set interrupt status to be false, so we may need to add <code>t.interrupt();</code> in catch block to reset it to be true.<h3 id="Communication"><a href="#Communication" class="headerlink" title="Communication"></a>Communication</h3></li>
</ul>
</li>
<li>wait(), notify(), notifyAll() need to be inside <code>synchronized</code></li>
<li>wait() will release lock</li>
<li>notify() will notify randomly</li>
<li>Sometimes need to use notifyAll() instead of notify(), otherwise the thread needs to be notified may not be notify<h2 id="Callable"><a href="#Callable" class="headerlink" title="Callable"></a>Callable</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">import java.util.concurrent.Callable;</span><br><span class="line">public class ThirdThread implements Callable&lt;String&gt; &#123;</span><br><span class="line">  @override</span><br><span class="line">  public String call() throws Exception &#123;</span><br><span class="line">    String str = &quot;the third way to create a thread&quot;;</span><br><span class="line">    return str;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public class ThirdThreadTest &#123;</span><br><span class="line">  public static void main(String[] args) &#123;</span><br><span class="line">    Callable&lt;String&gt; call = new ThirdThread();</span><br><span class="line">    FutureTask&lt;String&gt; ft = new FutureTask&lt;&gt;(call);</span><br><span class="line">    Thread thread = new Thread(ft);</span><br><span class="line"></span><br><span class="line">    thread.start();</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">      System.out.println(ft.get()); // get the result after the thread finishes, i.e. &quot;the third way to create a thread&quot;</span><br><span class="line">    &#125; catch (InterruptedException | ExecutionException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h1 id="Life-Cycle"><a href="#Life-Cycle" class="headerlink" title="Life Cycle"></a>Life Cycle</h1><ul>
<li>New</li>
<li>start() -&gt; Runnable</li>
<li>Running<ul>
<li>uses CPU</li>
<li>will turn into Runnable if time share is used up or yield()</li>
<li>will turn into Blocked if calls <code>child.join()</code> or <code>child.join(milliseconds)</code>, wait(), <code>t.sleep(milliseconds)</code>, sends I&#x2F;O request</li>
</ul>
</li>
<li>Blocked</li>
<li>Terminated: after run() finishes or throws an error</li>
</ul>
<h1 id="ThreadLocal"><a href="#ThreadLocal" class="headerlink" title="ThreadLocal"></a>ThreadLocal</h1><ul>
<li>When to use<ul>
<li>each thread needs an object<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">class ThreadSafeFormatter &#123;</span><br><span class="line">  // the initial value will be set at the first time get() is called  </span><br><span class="line">  public static ThreadLocal&lt;SimpleDateFormat&gt; dateFormatter</span><br><span class="line">    = ThreadLocal.withInitial(() -&gt; new SimpleDateFormat(&quot;HH:mm:ss&quot;));</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>each thread wants to use global variable without the hassle of passing paramters<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">class UserContextHolder &#123;</span><br><span class="line"></span><br><span class="line">    public static ThreadLocal&lt;User&gt; holder = new ThreadLocal&lt;&gt;();</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class Service1 &#123;</span><br><span class="line"></span><br><span class="line">  public void process(String name) &#123;</span><br><span class="line">      User user = new User(&quot;Liam&quot;);</span><br><span class="line">      UserContextHolder.holder.set(user);</span><br><span class="line">      new Service2().process();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class Service2 &#123;</span><br><span class="line"></span><br><span class="line">    public void process() &#123;</span><br><span class="line">        User user = UserContextHolder.holder.get();</span><br><span class="line">        ThreadSafeFormatter.dateFormatThreadLocal.get();</span><br><span class="line">        System.out.println(&quot;Service2 has gotten: &quot; + user.name);</span><br><span class="line">        new Service3().process();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class Service3 &#123;</span><br><span class="line"></span><br><span class="line">    public void process() &#123;</span><br><span class="line">        User user = UserContextHolder.holder.get();</span><br><span class="line">        System.out.println(&quot;Service3 has gotten: &quot; + user.name);</span><br><span class="line">        UserContextHolder.holder.remove();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li>prevent OOM<ul>
<li>after finishing using ThreadLocal, call <code>void remove()</code></li>
</ul>
</li>
</ul>
<h1 id="Safety"><a href="#Safety" class="headerlink" title="Safety"></a>Safety</h1><ul>
<li>need to consider when we will have<ul>
<li>will change the global variable</li>
<li>or there is “escaping”:<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">final int x;</span><br><span class="line">  // Wrong contructor</span><br><span class="line">  public FinalFieldExample() &#123;</span><br><span class="line">    x = 3;</span><br><span class="line">    y = 4;</span><br><span class="line">    // &quot;escaping&quot;. if the thread reads x through global.obj, it may get 0</span><br><span class="line">    global.obj = this;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li>reason: race condition: result depends on timing of execution of threads</li>
<li>visibility: happens-before<ul>
<li>order within same thread</li>
<li>writing volatile (read in and write to memory rather than CPU cache)</li>
<li>A happens-before B and B happens-before C, then A happens-before C</li>
<li>For the same lock, locking happends-before unlocking. To make addOne() visible to get():<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">class SafeCalc &#123;</span><br><span class="line">  long value = 0L;</span><br><span class="line">  synchronized long get() &#123; return value; &#125;</span><br><span class="line">  synchronized void addOne() &#123; value += 1; &#125;&#125;</span><br></pre></td></tr></table></figure></li>
<li>a thread changes variable within critical area</li>
<li>child thread can see operation results of parent thread before the child thread is started by start()</li>
<li>parent thread calls join(), after child thread finishes, parent thread can see operation results of child thread<h1 id="Lock"><a href="#Lock" class="headerlink" title="Lock"></a>Lock</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">private final Object</span><br><span class="line">  lock = new Object();</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><code>synchronized</code> will writing thread id into lock object head</li>
<li>lock should be unchangable and should not be reused (e.g. Integer, String, Boolean will be reused). Ratio of resources to lock should be N : 1.</li>
</ul>
<h2 id="Dead-Lock"><a href="#Dead-Lock" class="headerlink" title="Dead Lock"></a>Dead Lock</h2><ul>
<li>when: occupy and wait, cannot deprive, wait loop</li>
<li>solution<ul>
<li>release resources being occupied if the thread cannot get other resources needed</li>
<li>avoid wait loop. For example, when acquiring resources, start from the resource with smaller id<h2 id="Live-Lock"><a href="#Live-Lock" class="headerlink" title="Live Lock"></a>Live Lock</h2></li>
</ul>
</li>
<li>when: “give way” example</li>
<li>solution: random</li>
</ul>
<h1 id="Performance"><a href="#Performance" class="headerlink" title="Performance"></a>Performance</h1><ul>
<li>No lock or do not lock for too long</li>
</ul>
<h1 id="JUC"><a href="#JUC" class="headerlink" title="JUC"></a>JUC</h1><h2 id="ThreadPool"><a href="#ThreadPool" class="headerlink" title="ThreadPool"></a>ThreadPool</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ThreadPoolExecutor(</span><br><span class="line">  int corePoolSize,</span><br><span class="line">  int maximumPoolSize,</span><br><span class="line">  long keepAliveTime,</span><br><span class="line">  TimeUnit unit,</span><br><span class="line">  BlockingQueue&lt;Runnable&gt; workQueue,</span><br><span class="line">  ThreadFactory threadFactory,</span><br><span class="line">  RejectedExecutionHandler handler)</span><br></pre></td></tr></table></figure>
<p>some handers:</p>
<ul>
<li>CallerRunsPolicy</li>
<li>AbortPolicy: default, throws RejectedExecutionException</li>
<li>DiscardPolicy</li>
<li>DiscardOldestPolicy</li>
<li>can custom handler<br>allowCoreThreadTimeOut(boolean value)<br>unbounded LinkedBlockingQueue may cause OOM, should use bounded:<br><code>BlockingQueue workQueue = new LinkedBlockingQueue&lt;&gt;(2);</code></li>
</ul>
<ul>
<li>need to catch exception thrown by execute()</li>
<li>How many threads<ul>
<li>CPU-intensive: CPU cores + 1</li>
<li>I&#x2F;O-intensive: CPU cores * [ 1 +（I&#x2F;O time &#x2F; CPU time）], need stress test. Initial value could be 2 * cores + 1 (<a target="_blank" rel="noopener" href="https://github.com/brettwooldridge/HikariCP/wiki/About-Pool-Sizing">https://github.com/brettwooldridge/HikariCP/wiki/About-Pool-Sizing</a>)</li>
</ul>
</li>
<li>give the thread a meaningful name</li>
</ul>
<h2 id="CompletionService"><a href="#CompletionService" class="headerlink" title="CompletionService"></a>CompletionService</h2><ul>
<li>adding finished task to a blocking queue<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ExecutorCompletionService(Executor executor) // using unbounded LinkedBlockingQueue</span><br><span class="line">ExecutorCompletionService(Executor executor, BlockingQueue&gt; completionQueue)</span><br><span class="line"></span><br><span class="line">Future&lt;V&gt; submit(Callable&lt;V&gt; task);</span><br><span class="line">Future&lt;V&gt; submit(Runnable task, V result);</span><br><span class="line">Future&lt;V&gt; take() throws InterruptedException;</span><br><span class="line">Future&lt;V&gt; poll();</span><br><span class="line">Future&lt;V&gt; poll(long timeout, TimeUnit unit) throws InterruptedException;</span><br></pre></td></tr></table></figure>
<h2 id="Atomic"><a href="#Atomic" class="headerlink" title="Atomic"></a>Atomic</h2></li>
<li>when: if only one shared variable<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">public class Test &#123;</span><br><span class="line">  AtomicLong count =</span><br><span class="line">    new AtomicLong(0);</span><br><span class="line">  void add10K() &#123;</span><br><span class="line">    int idx = 0;</span><br><span class="line">    while(idx++ &lt; 10000) &#123;</span><br><span class="line">      count.getAndIncrement();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>primitive<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">getAndIncrement()</span><br><span class="line">getAndDecrement()</span><br><span class="line">incrementAndGet()</span><br><span class="line">decrementAndGet()</span><br><span class="line"></span><br><span class="line">getAndAdd(delta)</span><br><span class="line"></span><br><span class="line">addAndGet(delta)</span><br><span class="line">compareAndSet(expect, update)</span><br><span class="line"></span><br><span class="line">// new value can be calcuated by func</span><br><span class="line">getAndUpdate(func)</span><br><span class="line">updateAndGet(func)</span><br><span class="line">getAndAccumulate(x,func)</span><br><span class="line">accumulateAndGet(x,func)</span><br></pre></td></tr></table></figure></li>
<li>ABA issue</li>
<li>AtomicReference, AtomicStampedReference, AtomicMarkableReference<ul>
<li><code>AtomicStampedReference&lt;T&gt;(value, stamp)</code></li>
</ul>
</li>
<li>AtomicIntegerArray, AtomicLongArray, AtomicReferenceArray</li>
<li>AtomicIntegerFieldUpdater, AtomicLongFieldUpdater, AtomicReferenceFieldUpdater</li>
<li>DoubleAccumulator, DoubleAdder, LongAccumulator, LongAdder</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://liamyaolian.github.io/2022/12/07/Docker/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Liam Lian">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Liam Lian's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/12/07/Docker/" class="post-title-link" itemprop="url">Docker</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-12-07 13:36:45" itemprop="dateCreated datePublished" datetime="2022-12-07T13:36:45-05:00">2022-12-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-12-08 12:43:59" itemprop="dateModified" datetime="2022-12-08T12:43:59-05:00">2022-12-08</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">docker pull ubuntu:18.04</span><br><span class="line">docker run -it ubuntu:18.04 sh</span><br><span class="line"></span><br><span class="line"># commands below will be executed in the container</span><br><span class="line">cat /etc/os-release</span><br><span class="line">apt update</span><br><span class="line">apt install -y wget redis</span><br><span class="line">redis-server &amp;</span><br></pre></td></tr></table></figure>
<p><code>docker pull</code> to pull images from remote registry<br><code>docker images</code> to list local images<br><code>docker rmi</code> to remove local images<br><code>-d</code><br><code>-it</code></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://liamyaolian.github.io/2022/12/06/Redis-Basic/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Liam Lian">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Liam Lian's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/12/06/Redis-Basic/" class="post-title-link" itemprop="url">Redis Basic</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-12-06 16:28:35 / Modified: 20:39:26" itemprop="dateCreated datePublished" datetime="2022-12-06T16:28:35-05:00">2022-12-06</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Redis"><a href="#Redis" class="headerlink" title="Redis"></a>Redis</h1><ul>
<li>One thread, I&#x2F;O multiplexing<h1 id="String"><a href="#String" class="headerlink" title="String"></a>String</h1></li>
<li>GETSET command sets a key to a new value, returning the old value as the result</li>
<li>Set value if key not exist</li>
<li>Set value if key exists<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; set mykey newval nx</span><br><span class="line">(nil)</span><br><span class="line">&gt; set mykey newval xx</span><br><span class="line">OK</span><br></pre></td></tr></table></figure></li>
<li>Set value with expiration<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; set key 100 ex 10</span><br><span class="line">OK</span><br><span class="line">&gt; ttl key</span><br><span class="line">(integer) 9</span><br></pre></td></tr></table></figure></li>
<li>mset<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt; mset a 10 b 20 c 30</span><br><span class="line">OK</span><br><span class="line">&gt; mget a b c</span><br><span class="line">1) &quot;10&quot;</span><br><span class="line">2) &quot;20&quot;</span><br><span class="line">3) &quot;30&quot;</span><br></pre></td></tr></table></figure></li>
<li>atomic: That even multiple clients issuing INCR against the same key will never enter into a race condition</li>
</ul>
<ul>
<li>incr</li>
<li>incrby</li>
<li>decr</li>
<li>decrby<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&gt; set counter 100</span><br><span class="line">OK</span><br><span class="line">&gt; incr counter</span><br><span class="line">(integer) 101</span><br><span class="line">&gt; incr counter</span><br><span class="line">(integer) 102</span><br><span class="line">&gt; incrby counter 50</span><br><span class="line">(integer) 152</span><br></pre></td></tr></table></figure></li>
</ul>
<ul>
<li>exists</li>
<li>del</li>
<li>type<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; exists mykey</span><br><span class="line">(integer) 1</span><br><span class="line">&gt; del mykey</span><br><span class="line">(integer) 1</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt; type mykey</span><br><span class="line">string</span><br><span class="line">&gt; del mykey</span><br><span class="line">(integer) 1</span><br><span class="line">&gt; type mykey</span><br><span class="line">none</span><br></pre></td></tr></table></figure></li>
<li>expire in 5 seconds<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; expire key 5</span><br><span class="line">(integer) 1</span><br></pre></td></tr></table></figure>
Note: In order to set and check expires in milliseconds, check the PEXPIRE and the PTTL commands, and the full list of SET options.<h1 id="List"><a href="#List" class="headerlink" title="List"></a>List</h1></li>
<li>Redis lists are implemented via Linked Lists<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&gt; rpush mylist A</span><br><span class="line">(integer) 1</span><br><span class="line">&gt; rpush mylist B</span><br><span class="line">(integer) 2</span><br><span class="line">&gt; lpush mylist first</span><br><span class="line">(integer) 3</span><br><span class="line">&gt; lrange mylist 0 -1</span><br><span class="line">1) &quot;first&quot;</span><br><span class="line">2) &quot;A&quot;</span><br><span class="line">3) &quot;B&quot;</span><br></pre></td></tr></table></figure></li>
<li>lrange is for display<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&gt; rpush mylist 1 2 3 4 5 &quot;foo bar&quot;</span><br><span class="line">(integer) 9</span><br><span class="line">&gt; lrange mylist 0 -1</span><br><span class="line">1) &quot;first&quot;</span><br><span class="line">2) &quot;A&quot;</span><br><span class="line">3) &quot;B&quot;</span><br><span class="line">4) &quot;1&quot;</span><br><span class="line">5) &quot;2&quot;</span><br><span class="line">6) &quot;3&quot;</span><br><span class="line">7) &quot;4&quot;</span><br><span class="line">8) &quot;5&quot;</span><br><span class="line">9) &quot;foo bar&quot;</span><br></pre></td></tr></table></figure></li>
<li>ltrim will change the list<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&gt; rpush mylist 1 2 3 4 5</span><br><span class="line">(integer) 5</span><br><span class="line">&gt; ltrim mylist 0 2</span><br><span class="line">OK</span><br><span class="line">&gt; lrange mylist 0 -1</span><br><span class="line">1) &quot;1&quot;</span><br><span class="line">2) &quot;2&quot;</span><br><span class="line">3) &quot;3&quot;</span><br></pre></td></tr></table></figure></li>
<li>blpop and brpop will block if the list is empty<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; brpop tasks 5</span><br><span class="line">1) &quot;tasks&quot;</span><br><span class="line">2) &quot;do_something&quot;</span><br></pre></td></tr></table></figure>
“wait for elements in the list tasks, but return NULL if after 5 seconds no element is available”. 0 means waiting forever</li>
</ul>
<ul>
<li>the first client that blocked waiting for a list, is served first when an element is pushed by some other client, and so forth.</li>
</ul>
<ul>
<li>BLMOVE</li>
<li>Automatic creation and removal of keys</li>
</ul>
<ol>
<li>When we add an element to an aggregate data type, if the target key does not exist, an empty aggregate data type is created before adding the element.</li>
<li>When we remove elements from an aggregate data type, if the value remains empty, the key is automatically destroyed. The Stream data type is the only exception to this rule.</li>
<li>Calling a read-only command such as LLEN (which returns the length of the list), or a write command removing elements, with an empty key, always produces the same result as if the key is holding an empty aggregate type of the type the command expects to find.</li>
</ol>
<h1 id="Hash"><a href="#Hash" class="headerlink" title="Hash"></a>Hash</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&gt; hset user:1000 username antirez birthyear 1977 verified 1</span><br><span class="line">(integer) 3</span><br><span class="line">&gt; hget user:1000 username</span><br><span class="line">&quot;antirez&quot;</span><br><span class="line">&gt; hget user:1000 birthyear</span><br><span class="line">&quot;1977&quot;</span><br><span class="line">&gt; hgetall user:1000</span><br><span class="line">1) &quot;username&quot;</span><br><span class="line">2) &quot;antirez&quot;</span><br><span class="line">3) &quot;birthyear&quot;</span><br><span class="line">4) &quot;1977&quot;</span><br><span class="line">5) &quot;verified&quot;</span><br><span class="line">6) &quot;1&quot;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; hmget user:1000 username birthyear no-such-field</span><br><span class="line">1) &quot;antirez&quot;</span><br><span class="line">2) &quot;1977&quot;</span><br><span class="line">3) (nil)</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; hincrby user:1000 birthyear 10</span><br><span class="line">(integer) 1987</span><br><span class="line">&gt; hincrby user:1000 birthyear 10</span><br><span class="line">(integer) 1997</span><br></pre></td></tr></table></figure>
<h1 id="Set"><a href="#Set" class="headerlink" title="Set"></a>Set</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&gt; sadd myset 1 2 3</span><br><span class="line">(integer) 3</span><br><span class="line">&gt; smembers myset</span><br><span class="line">1. 3</span><br><span class="line">2. 1</span><br><span class="line">3. 2</span><br><span class="line">&gt; sismember myset 3</span><br><span class="line">(integer) 1</span><br><span class="line">&gt; sismember myset 30</span><br><span class="line">(integer) 0</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>intersection between different sets<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; sinter tag:1:news tag:2:news tag:10:news tag:27:news</span><br></pre></td></tr></table></figure></li>
<li>SPOP command removes a random element, returning it to the client</li>
<li>SRANDMEMBER will return a random element without removing it</li>
<li>Number of elements<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; scard game:1:deck</span><br><span class="line">(integer) 47</span><br></pre></td></tr></table></figure>
<h1 id="Sorted-sets"><a href="#Sorted-sets" class="headerlink" title="Sorted sets"></a>Sorted sets</h1></li>
<li>zadd key score value<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&gt; zadd hackers 1940 &quot;Alan Kay&quot;</span><br><span class="line">(integer) 1</span><br><span class="line">&gt; zadd hackers 1957 &quot;Sophie Wilson&quot;</span><br><span class="line">(integer) 1</span><br><span class="line">&gt; zadd hackers 1953 &quot;Richard Stallman&quot;</span><br><span class="line">(integer) 1</span><br><span class="line">&gt; zadd hackers 1949 &quot;Anita Borg&quot;</span><br><span class="line">(integer) 1</span><br><span class="line">&gt; zadd hackers 1965 &quot;Yukihiro Matsumoto&quot;</span><br><span class="line">(integer) 1</span><br><span class="line">&gt; zadd hackers 1914 &quot;Hedy Lamarr&quot;</span><br><span class="line">(integer) 1</span><br><span class="line">&gt; zadd hackers 1916 &quot;Claude Shannon&quot;</span><br><span class="line">(integer) 1</span><br><span class="line">&gt; zadd hackers 1969 &quot;Linus Torvalds&quot;</span><br><span class="line">(integer) 1</span><br><span class="line">&gt; zadd hackers 1912 &quot;Alan Turing&quot;</span><br><span class="line">(integer) 1</span><br></pre></td></tr></table></figure></li>
</ul>
<ul>
<li>If B and A are two elements with a different score, then A &gt; B if A.score is &gt; B.score.</li>
<li>If B and A have exactly the same score, then A &gt; B if the A string is lexicographically greater than the B string. B and A strings can’t be equal since sorted sets only have unique elements.<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&gt; zrange hackers 0 -1</span><br><span class="line">1) &quot;Alan Turing&quot;</span><br><span class="line">2) &quot;Hedy Lamarr&quot;</span><br><span class="line">3) &quot;Claude Shannon&quot;</span><br><span class="line">4) &quot;Alan Kay&quot;</span><br><span class="line">5) &quot;Anita Borg&quot;</span><br><span class="line">6) &quot;Richard Stallman&quot;</span><br><span class="line">7) &quot;Sophie Wilson&quot;</span><br><span class="line">8) &quot;Yukihiro Matsumoto&quot;</span><br><span class="line">9) &quot;Linus Torvalds&quot;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&gt; zrevrange hackers 0 -1</span><br><span class="line">1) &quot;Linus Torvalds&quot;</span><br><span class="line">2) &quot;Yukihiro Matsumoto&quot;</span><br><span class="line">3) &quot;Sophie Wilson&quot;</span><br><span class="line">4) &quot;Richard Stallman&quot;</span><br><span class="line">5) &quot;Anita Borg&quot;</span><br><span class="line">6) &quot;Alan Kay&quot;</span><br><span class="line">7) &quot;Claude Shannon&quot;</span><br><span class="line">8) &quot;Hedy Lamarr&quot;</span><br><span class="line">9) &quot;Alan Turing&quot;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&gt; zrange hackers 0 -1 withscores</span><br><span class="line">1) &quot;Alan Turing&quot;</span><br><span class="line">2) &quot;1912&quot;</span><br><span class="line">3) &quot;Hedy Lamarr&quot;</span><br><span class="line">4) &quot;1914&quot;</span><br><span class="line">5) &quot;Claude Shannon&quot;</span><br><span class="line">6) &quot;1916&quot;</span><br><span class="line">7) &quot;Alan Kay&quot;</span><br><span class="line">8) &quot;1940&quot;</span><br><span class="line">9) &quot;Anita Borg&quot;</span><br><span class="line">10) &quot;1949&quot;</span><br><span class="line">11) &quot;Richard Stallman&quot;</span><br><span class="line">12) &quot;1953&quot;</span><br><span class="line">13) &quot;Sophie Wilson&quot;</span><br><span class="line">14) &quot;1957&quot;</span><br><span class="line">15) &quot;Yukihiro Matsumoto&quot;</span><br><span class="line">16) &quot;1965&quot;</span><br><span class="line">17) &quot;Linus Torvalds&quot;</span><br><span class="line">18) &quot;1969&quot;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt; zrangebyscore hackers -inf 1950</span><br><span class="line">1) &quot;Alan Turing&quot;</span><br><span class="line">2) &quot;Hedy Lamarr&quot;</span><br><span class="line">3) &quot;Claude Shannon&quot;</span><br><span class="line">4) &quot;Alan Kay&quot;</span><br><span class="line">5) &quot;Anita Borg&quot;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; zremrangebyscore hackers 1940 1960</span><br><span class="line">(integer) 4</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; zrank hackers &quot;Anita Borg&quot;</span><br><span class="line">(integer) 4</span><br></pre></td></tr></table></figure>
ZREVRANK</li>
</ul>
<ul>
<li>Lexicographical scores<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; zadd hackers 0 &quot;Alan Kay&quot; 0 &quot;Sophie Wilson&quot; 0 &quot;Richard Stallman&quot; 0</span><br><span class="line">  &quot;Anita Borg&quot; 0 &quot;Yukihiro Matsumoto&quot; 0 &quot;Hedy Lamarr&quot; 0 &quot;Claude Shannon&quot;</span><br><span class="line">  0 &quot;Linus Torvalds&quot; 0 &quot;Alan Turing&quot;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&gt; zrange hackers 0 -1</span><br><span class="line">1) &quot;Alan Kay&quot;</span><br><span class="line">2) &quot;Alan Turing&quot;</span><br><span class="line">3) &quot;Anita Borg&quot;</span><br><span class="line">4) &quot;Claude Shannon&quot;</span><br><span class="line">5) &quot;Hedy Lamarr&quot;</span><br><span class="line">6) &quot;Linus Torvalds&quot;</span><br><span class="line">7) &quot;Richard Stallman&quot;</span><br><span class="line">8) &quot;Sophie Wilson&quot;</span><br><span class="line">9) &quot;Yukihiro Matsumoto&quot;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; zrangebylex hackers [B [P</span><br><span class="line">1) &quot;Claude Shannon&quot;</span><br><span class="line">2) &quot;Hedy Lamarr&quot;</span><br><span class="line">3) &quot;Linus Torvalds&quot;</span><br></pre></td></tr></table></figure>
Just calling ZADD against an element already included in the sorted set will update its score (and position) with O(log(N)) time complexity.<h1 id="Bitmap"><a href="#Bitmap" class="headerlink" title="Bitmap"></a>Bitmap</h1>a set of bit-oriented operations defined on the String type<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt; setbit key 10 1</span><br><span class="line">(integer) 1</span><br><span class="line">&gt; getbit key 10</span><br><span class="line">(integer) 1</span><br><span class="line">&gt; getbit key 11</span><br><span class="line">(integer) 0</span><br></pre></td></tr></table></figure>
The SETBIT command takes as its first argument the bit number, and as its second argument the value to set the bit to, which is 1 or 0.<br>GETBIT just returns the value of the bit at the specified index. Out of range bits (addressing a bit that is outside the length of the string stored into the target key) are always considered to be zero.</li>
</ul>
<p>There are three commands operating on group of bits:</p>
<p>BITOP performs bit-wise operations between different strings. The provided operations are AND, OR, XOR and NOT.<br>BITCOUNT performs population counting, reporting the number of bits set to 1.<br>BITPOS finds the first bit having the specified value of 0 or 1.</p>
<h1 id="HyperLogLogs"><a href="#HyperLogLogs" class="headerlink" title="HyperLogLogs"></a>HyperLogLogs</h1><ul>
<li>to estimate unique things with standard error of &lt; 1%.<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; pfadd hll a b c d</span><br><span class="line"> (integer) 1</span><br><span class="line"> &gt; pfcount hll</span><br><span class="line"> (integer) 4</span><br></pre></td></tr></table></figure></li>
</ul>
<h1 id="Stream"><a href="#Stream" class="headerlink" title="Stream"></a>Stream</h1><h1 id="Persistence"><a href="#Persistence" class="headerlink" title="Persistence"></a>Persistence</h1><ul>
<li><p>RDB (Redis Database): point-in-time snapshots of your dataset at specified intervals.</p>
<ul>
<li>pro<ul>
<li>single file, good for backup and disaster recovery</li>
<li>maximize performance because parent process forks a child to persist</li>
<li>faster restart compared to AOF</li>
<li>On replicas, RDB supports partial resynchronizations after restarts and failovers.</li>
</ul>
</li>
<li>con<ul>
<li>may have data loss</li>
<li>fork() can be time consuming if the dataset is big, and may result in Redis stopping serving clients for some milliseconds or even for one second if the dataset is very big and the CPU performance is not great. AOF also needs to fork() but less frequently</li>
</ul>
</li>
</ul>
</li>
<li><p>AOF (Append Only File): AOF persistence logs every write operation received by the server. These operations can then be replayed again at server startup, reconstructing the original dataset. Commands are logged using the same format as the Redis protocol itself.</p>
<ul>
<li>con<ul>
<li>AOF files are usually bigger than the equivalent RDB files for the same dataset.</li>
<li>AOF can be slower than RDB depending on the exact fsync policy.</li>
</ul>
</li>
</ul>
</li>
<li><p>No persistence</p>
</li>
<li><p>RDB + AOF</p>
</li>
<li><p>In the case both AOF and RDB persistence are enabled (recommended) and Redis restarts the AOF file will be used to reconstruct the original dataset since it is guaranteed to be the most complete</p>
</li>
</ul>
<h1 id="Issues"><a href="#Issues" class="headerlink" title="Issues"></a>Issues</h1><ul>
<li>Cache avalanche<ul>
<li>cache is not available and all requests reach DB</li>
<li>solution<ul>
<li>circuit breaker</li>
<li>master-slave or cluster to ensure avaibility</li>
</ul>
</li>
</ul>
</li>
<li>cache penetration<ul>
<li>frequenly query a data (e.g. ID &#x3D; -1) that does not exist in both DB and cache, crush the DB</li>
<li>solution<ul>
<li>check with codes (e.g. id cannot be less than 0)</li>
<li>save to Redis with null as value, TTL 30</li>
<li>Bloom Filter &#x2F;&#x2F; TODO</li>
</ul>
</li>
</ul>
</li>
<li>expired hotspot<ul>
<li>solution<ul>
<li>set hotspot to “never expire”</li>
<li>do not make a lot of keys expire at the same time</li>
<li>lock to ensure requests regarding the same data will not reach DB at the same time<h1 id="Cache-elimination-strategy"><a href="#Cache-elimination-strategy" class="headerlink" title="Cache elimination strategy"></a>Cache elimination strategy</h1>noeviction<br>allkeys-lru<br>volatile-lru<br>allkeys-random<br>volatile-random<br>volatile-ttl</li>
</ul>
</li>
</ul>
</li>
</ul>
<h1 id="Implement-queue"><a href="#Implement-queue" class="headerlink" title="Implement queue"></a>Implement queue</h1><ul>
<li>delayed queue: sorted set, timestamp as score, zrangebyscore to get data added n seconds ago</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://liamyaolian.github.io/2022/11/30/MySQL-Optimization-V2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Liam Lian">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Liam Lian's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/11/30/MySQL-Optimization-V2/" class="post-title-link" itemprop="url">MySQL Optimization V2</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-11-30 10:05:46 / Modified: 16:33:09" itemprop="dateCreated datePublished" datetime="2022-11-30T10:05:46-05:00">2022-11-30</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Transaction-and-Lock"><a href="#Transaction-and-Lock" class="headerlink" title="Transaction and Lock"></a>Transaction and Lock</h1><ul>
<li><p>Use InnoDB (default setting) reduces great hassle. Transaction is implemented by storage engine. If your transaction uses Table A and Table B and Table B’s storage engine does not support transaction, MySQL does not throw an error and data on Table B will not be rolled back.<br>Note: Lock is release on commit or roll back.</p>
</li>
<li><p>Use lock with smaller granularity to allow more concurrency. But more locks consumes more resources. It is a trade off.</p>
</li>
<li><p>Retry after deadlock is detected. InnoDB storage engine will notice circular dependencies and return an error instantly. InnoDB rolls back the transaction that has the fewest exclusive row locks.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># Transaction 1</span><br><span class="line">START TRANSACTION;</span><br><span class="line">UPDATE StockPrice SET close = 45.50 WHERE stock_id = 4 and date = ‘2020-05-01’;</span><br><span class="line">UPDATE StockPrice SET close = 19.80 WHERE stock_id = 3 and date = ‘2020-05-02’;</span><br><span class="line">COMMIT;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># Transaction 2</span><br><span class="line">START TRANSACTION;</span><br><span class="line">UPDATE StockPrice SET high = 20.12 WHERE stock_id = 3 and date = &#x27;2020-05-02&#x27;;</span><br><span class="line">UPDATE StockPrice SET high = 47.20 WHERE stock_id = 4 and date = &#x27;2020-05-01&#x27;;</span><br><span class="line">COMMIT;</span><br></pre></td></tr></table></figure></li>
<li><p>If you set AUTOCOMMIT &#x3D; 0, you are always in a transaction until you issue a COMMIT or ROLLBACK. MySQL then starts a new transaction immediately.</p>
</li>
<li><p>If You set AUTOCOMMIT &#x3D; 1, use <code>begin</code> and <code>start transaction</code> if one transaction has many queries<br>Note: Certain commands (typically DDL such as ALTER TABLE, but may be others such as LOCK TABLES) cause MySQL to commit the transaction before they execute.</p>
</li>
<li><p>Choose the suitable isolation level: READ COMMITTED, READ UNCOMMITTED, REPEATABLE READ, (usually not choose) SERIALIZABLE</p>
</li>
<li><p>Understand how MVCC allows most read queries not needing to acquire locks. <code>READ COMMITTED</code> and <code>REPEATABLE READ</code> use MVCC, while <code>READ UNCOMMITTED</code> and <code>SERIALIZABLE</code> do not need it.<br>InnoDB implements MVCC by assigning a transaction ID for each transaction at the first time the transaction reads any data. When a record is modified within that transaction, an undo record that explains how to revert that change is written to the undo log, and the rollback pointer of the transaction is pointed at that undo log record.</p>
</li>
<li><p>May need to use explicit locking:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SELECT ... FOR SHARE          // After MySQL 8.0</span><br><span class="line">SELECT ... FOR UPDATE</span><br></pre></td></tr></table></figure>
<p>S Lock: Other sessions can read the rows, but cannot modify them until your transaction commits. If any of these rows were changed by another transaction that has not yet committed, your query waits until that transaction ends and then uses the latest values.</p>
</li>
</ul>
<p>X Lock: If one transaction adds an X lock on a record, other transactions cannot add locks on it but need to wait.</p>
<h1 id="Schema"><a href="#Schema" class="headerlink" title="Schema"></a>Schema</h1><h2 id="Data-Type"><a href="#Data-Type" class="headerlink" title="Data Type"></a>Data Type</h2><ol>
<li>Smaller is usually better than bigger. For example, if <code>TINYINT</code> is sufficient, it is more efficient than <code>INT</code>.</li>
<li>Estimate conservatively. Realizing the data type is not big enough after the code has been in production is more painful.</li>
<li>Simple is good. For example, integers are cheaper than characters.</li>
<li>Avoid <code>null</code> if possible. Set a default value to leverage index.</li>
<li><code>DECIMAL</code> is precise but more expensive. In some high-volume cases, use a BIGINT instead and store the data as some multiple of the smallest fraction of currency. For example, multiply all dollar amounts by a million and store the result in a BIGINT.</li>
<li><code>VARCHAR</code> require less storage space than fixed-length types because it uses only as much space as it needs. However, because the rows are variable length, they can grow when you update them, which can cause extra work. If a row grows and no longer fits in its original location, the behavior is storage engine dependent. For example, InnoDB may need to split the page to fit the row into it. It’s usually worth using VARCHAR when the maximum column length is much larger than the average length; when updates to the field are rare, so fragmentation is not a problem; and when you’re using a complex character set such as UTF-8, where each character uses a variable number of bytes of storage.</li>
<li>Using ENUM instead of a string type. ENUM is 1 or 2 bytes. ENUM is stored as integers as the sequence specified in the definition. Avoid <code>ENUM(&#39;1&#39;, &#39;2&#39;, &#39;3&#39;)</code>. ENUM will be converted to string in a string context. If you want to sort them alphabetically:<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT e FROM enum_test ORDER BY FIELD(e, &#x27;apple&#x27;, &#x27;dog&#x27;, &#x27;fish&#x27;);</span><br></pre></td></tr></table></figure></li>
<li>DATETIME is independent of TIMEZONE, 8 bytes, millisecond-precision, from the year 1000 to the year 9999. TIMESTAMP depends on TIMEZONE, 4 bytes, second-precision, from 1970-1-1 midnight GMT to 2038-1-19. MySQL server, operating system, and client connections all have time zone settings.</li>
</ol>
<h2 id="Primary-KEY"><a href="#Primary-KEY" class="headerlink" title="Primary KEY"></a>Primary KEY</h2><ol>
<li>Once you choose a type for PK, make sure you use the same type in all related tables</li>
<li>The Smaller, the better</li>
<li>Integer is usually better than string</li>
<li>Avoid random number, because values will be distributed over a large space. If you still want to use UUID, convert it into 16-byte numbers with UNHEX() and store them in a BINARY(16) column. You can retrieve the values in hexadecimal format with the HEX() function.</li>
</ol>
<h2 id="Other"><a href="#Other" class="headerlink" title="Other"></a>Other</h2><ul>
<li>If a table have hundreds of columns, even if we only use a few columns, InnoDB will parse all columns, which is expensive.</li>
</ul>
<h2 id="Summary-Table"><a href="#Summary-Table" class="headerlink" title="Summary Table"></a>Summary Table</h2><ul>
<li>To improve performance</li>
</ul>
<h1 id="Index"><a href="#Index" class="headerlink" title="Index"></a>Index</h1><h2 id="B-Tree"><a href="#B-Tree" class="headerlink" title="B Tree"></a>B Tree</h2><ul>
<li>Avoid duplicate, redundant, unused indices, because MySQL has to maintain each index separately.</li>
<li>Use cluster index if possible. Cluster index leaf stores the row. Non-cluster index leaf stores PK.</li>
<li>The leaf pages can perform better if they are physically sequential, otherwise it’s called “fragmented” and range scans or full index scans are slower. Avoid that with random values such as UUID. To defragment data, you can either run OPTIMIZE TABLE or dump and reload the data.</li>
<li>Use multicolumn index if possible instead of many indices on single columns (because MySQL needs to do “index merge” for the latter one), and consider:<ul>
<li>using covering index, which is an index that contains (or “covers”) all the data needed to satisfy a query.</li>
<li>the left-most rule when deciding the order of columns.</li>
<li>what sorting is needed in queries. B-tree indexes stores the data in sorted order, and MySQL can exploit that for ORDER BY and GROUP BY. Ordering the results by the index does not work if a column in ORDER BY is not in the index or the order in ORDER BY is not the order of the index. If you need to sort in different directions, a trick is to store a reversed or negated value.<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE rental (</span><br><span class="line"> ...</span><br><span class="line"> PRIMARY KEY (rental_id),</span><br><span class="line"> UNIQUE KEY rental_date (rental_date,inventory_id,customer_id),</span><br><span class="line"> KEY idx_fk_inventory_id (inventory_id),</span><br><span class="line"> KEY idx_fk_customer_id (customer_id),</span><br><span class="line"> KEY idx_fk_staff_id (staff_id),</span><br><span class="line"> ...</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">... WHERE rental_date = &#x27;2005-05-25&#x27; ORDER BY inventory_id, staff_id;</span><br><span class="line"># does not use index because the ORDER BY refers to a column that isn’t in the index</span><br></pre></td></tr></table></figure>
The ORDER BY clause needs to form a leftmost prefix of the index unless leading columns are constants.<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE rental (</span><br><span class="line"> ...</span><br><span class="line"> PRIMARY KEY (rental_id),</span><br><span class="line"> UNIQUE KEY rental_date (rental_date,inventory_id,customer_id),</span><br><span class="line"> KEY idx_fk_inventory_id (inventory_id),</span><br><span class="line"> KEY idx_fk_customer_id (customer_id),</span><br><span class="line"> KEY idx_fk_staff_id (staff_id),</span><br><span class="line"> ...</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; EXPLAIN SELECT rental_id, staff_id FROM sakila.rental</span><br><span class="line">    -&gt; WHERE rental_date = &#x27;2005-05-25&#x27;</span><br><span class="line">    -&gt; ORDER BY inventory_id, customer_id\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line"> type: ref</span><br><span class="line"> possible_keys: rental_date</span><br><span class="line"> key: rental_date</span><br><span class="line"> rows: 1</span><br><span class="line"> Extra: Using where</span><br></pre></td></tr></table></figure>
If the query joins multiple tables, ordering the results by the index works only when all columns in the ORDER BY clause refer to the first table.</li>
<li>Assuming there is no sorting and group by, the column that can filter out the most rows should be the leftest.</li>
</ul>
</li>
<li>Consider using prefix to save storage. You must define prefix if you want to index BLOB, TEXT, or very long VARCHAR columns, because MySQL disallows indexing their full length.<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ALTER TABLE cities ADD KEY (city(7));</span><br></pre></td></tr></table></figure></li>
</ul>
<h1 id="Query-Tuning"><a href="#Query-Tuning" class="headerlink" title="Query Tuning"></a>Query Tuning</h1><h2 id="Slower-to-Fast"><a href="#Slower-to-Fast" class="headerlink" title="Slower to Fast"></a>Slower to Fast</h2><p>constants<br>unique index lookups<br>range scans<br>index scans<br>full table scans</p>
<h2 id="Tips"><a href="#Tips" class="headerlink" title="Tips"></a>Tips</h2><ol>
<li>Avoid <code>SELECT *</code>. Only include columns needed.</li>
<li>Choose the suitable query size. It is a trade-off between:</li>
</ol>
<ul>
<li>reduce the number of connections established.</li>
<li>avoid locking for too long if there is a lock.</li>
</ul>
<ol start="3">
<li>Do not perform calculation on index column while filtering. An example that violates this:  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT actor_id FROM actor WHERE actor_id + 1 = 5;</span><br></pre></td></tr></table></figure></li>
<li>Join</li>
</ol>
<ul>
<li>Avoid join too many tables. Join them in application.</li>
<li>The table has fewer rows that meet the ON criteria should be the “driver” table. You can manually use this rule in STRAIGHT JOIN, LEFT JOIN, and RIGHT JOIN.</li>
<li>If optimizer decides to join the tables in the order B, A, you need to add indexes only on the second table (Table A) in the join order.</li>
</ul>
<ol start="5">
<li>Avoid correlated subqueries:</li>
</ol>
<ul>
<li>Method 1: Replace IN with EXISTS  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT * FROM film</span><br><span class="line">  -&gt; WHERE EXISTS(</span><br><span class="line">  -&gt;    SELECT * FROM film_actor WHERE actor_id = 1</span><br><span class="line">  -&gt;       AND film_actor.film_id = film.film_id);</span><br></pre></td></tr></table></figure></li>
<li>Method 2: Join. But this may not be more efficient because it will join all rows that can be joined first before filtering.</li>
<li>Method 3: Generate the IN list with GROUP_CONCAT in another query</li>
</ul>
<ol start="6">
<li>GROUP BY and ORDER BY</li>
</ol>
<ul>
<li>Use columns in the same table in GROUP BY and ORDER BY to leverage index.</li>
<li>Use index if possible</li>
<li>Move the WITH ROLLUP functionality into your application code.</li>
</ul>
<ol start="7">
<li>LIMIT with large offet<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT film_id, description FROM sakila.film ORDER BY title LIMIT 50, 5;</span><br></pre></td></tr></table></figure></li>
</ol>
<ul>
<li>Method 1:<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT film.film_id, film.description</span><br><span class="line">    -&gt; FROM sakila.film</span><br><span class="line">    -&gt;    INNER JOIN (</span><br><span class="line">    -&gt;       SELECT film_id FROM sakila.film</span><br><span class="line">    -&gt;       ORDER BY title LIMIT 50, 5</span><br><span class="line">    -&gt;    ) AS lim USING(film_id);</span><br></pre></td></tr></table></figure></li>
<li>Method 2: position is indexed<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SELECT film_id, description FROM sakila.film</span><br><span class="line">WHERE position BETWEEN 50 AND 54 ORDER BY position;</span><br></pre></td></tr></table></figure></li>
<li>Method 3<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT * FROM sakila.rental</span><br><span class="line">-&gt; WHERE rental_id &lt; 16030</span><br><span class="line">-&gt; ORDER BY rental_id DESC LIMIT 20;</span><br></pre></td></tr></table></figure></li>
</ul>
<ol start="8">
<li>Replace <code>OR</code> with <code>IN</code>. MySQL uses binary search on the <code>IN</code> list. However, <code>IN</code> list that is too long may hurt performance,<br>because the optimizer may copy the list for all related tables (due to a WHERE, ON, or USING clause that sets the column equals to that on another table).</li>
<li>Union:</li>
</ol>
<ul>
<li>add filtering  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">(SELECT first_name, last_name</span><br><span class="line"> FROM sakila.actor</span><br><span class="line"> ORDER BY last_name)</span><br><span class="line">UNION ALL</span><br><span class="line">(SELECT first_name, last_name</span><br><span class="line"> FROM sakila.customer</span><br><span class="line"> ORDER BY last_name)</span><br><span class="line">LIMIT 20;</span><br></pre></td></tr></table></figure>
  Should be:  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">(SELECT first_name, last_name</span><br><span class="line"> FROM sakila.actor</span><br><span class="line"> ORDER BY last_name</span><br><span class="line"> LIMIT 20)</span><br><span class="line">UNION ALL</span><br><span class="line">(SELECT first_name, last_name</span><br><span class="line"> FROM sakila.customer</span><br><span class="line"> ORDER BY last_name</span><br><span class="line"> LIMIT 20)</span><br><span class="line">LIMIT 20;</span><br></pre></td></tr></table></figure></li>
<li>If sorting is not needed, use UNION ALL, because UNION will sort.</li>
</ul>
<ol start="10">
<li><p>MAX() and MIN()</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT MIN(actor_id) FROM sakila.actor WHERE first_name = &#x27;PENELOPE&#x27;;</span><br></pre></td></tr></table></figure>
<p>Can be:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT actor_id FROM sakila.actor USE INDEX(PRIMARY)</span><br><span class="line">    -&gt; WHERE first_name = &#x27;PENELOPE&#x27; LIMIT 1;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Count()</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SELECT SUM(IF(color = &#x27;blue&#x27;, 1, 0)) AS blue,SUM(IF(color = &#x27;red&#x27;, 1, 0))</span><br><span class="line">AS red FROM items;</span><br></pre></td></tr></table></figure></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://liamyaolian.github.io/2022/11/07/MQ/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Liam Lian">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Liam Lian's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/11/07/MQ/" class="post-title-link" itemprop="url">MQ</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-11-07 11:27:06 / Modified: 12:53:51" itemprop="dateCreated datePublished" datetime="2022-11-07T11:27:06-05:00">2022-11-07</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Why"><a href="#Why" class="headerlink" title="Why"></a>Why</h1><ul>
<li>asynchronous operation</li>
<li>decouple</li>
<li>rate limit<br>TODO</li>
</ul>
<h1 id="Challenge"><a href="#Challenge" class="headerlink" title="Challenge"></a>Challenge</h1><ul>
<li>lost message</li>
</ul>
<ul>
<li>After the message has been persisted in at least two servers, ack to producer</li>
<li>After consumer finishes business logic, ack</li>
</ul>
<ul>
<li>duplicate messages</li>
</ul>
<ul>
<li>version</li>
<li>id</li>
<li>unique key</li>
</ul>
<ul>
<li>order</li>
</ul>
<ul>
<li>globally: one producer, one queue, one thread consumes</li>
<li>locally: one thread consumes one queue</li>
</ul>
<ul>
<li>message accumulation</li>
</ul>
<ul>
<li>bug?</li>
<li>consuming slowly: optimize consumption, such as batch insert</li>
<li>scale-out: add more queues</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://liamyaolian.github.io/2022/11/05/SQL-Query-Tuning/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Liam Lian">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Liam Lian's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/11/05/SQL-Query-Tuning/" class="post-title-link" itemprop="url">SQL Query Tuning</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-11-05 11:47:08 / Modified: 16:49:19" itemprop="dateCreated datePublished" datetime="2022-11-05T11:47:08-04:00">2022-11-05</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="what-happens-when-you-send-MySQL-a-query"><a href="#what-happens-when-you-send-MySQL-a-query" class="headerlink" title="what happens when you send MySQL a query:"></a>what happens when you send MySQL a query:</h1><p>The client sends the SQL statement to the server.<br>The server checks the query cache. If there’s a hit, it returns the stored result from the cache; otherwise, it passes the SQL statement to the next step.<br>The server parses, preprocesses, and optimizes the SQL into a query execution plan.<br>The query execution engine executes the plan by making calls to the storage engine API.<br>The server sends the result to the client.</p>
<p>The protocol is half-duplex, which means that at any given time the MySQL server can be either sending or receiving messages, but not both. It also means there is no way to cut a message short.</p>
<p>the temporary table created by the subquery has no indexes.</p>
<h1 id="Metrics"><a href="#Metrics" class="headerlink" title="Metrics"></a>Metrics</h1><p>query cost metrics include:</p>
<ul>
<li>Execution time</li>
<li>Number of rows examined</li>
<li>Number of rows returned<br>Note: access types: a full table scan &gt; index scans &gt; range scans &gt; unique index lookups &gt; constants</li>
</ul>
<h1 id="Best-Practices"><a href="#Best-Practices" class="headerlink" title="Best Practices"></a>Best Practices</h1><ul>
<li>Try changing the schema such as using summary tables</li>
<li>Try covering indexes</li>
<li>Use as few queries as possible, but sometimes executing a few simple queries instead of one complex one.</li>
<li>Avoid retrieving unnecessary data such as <code>select *</code></li>
<li>union<ul>
<li>filter out unnecessary rows within union</li>
<li>use union all instead of union if possible</li>
</ul>
</li>
<li>Sometimes avoid correlated subqueries.<ul>
<li>use join</li>
<li>or manually generate the IN() list by executing the subquery as a separate query with GROUP_CONCAT(). Sometimes this can be faster than a JOIN.</li>
</ul>
</li>
<li>join<ul>
<li>decompose a join by running multiple single-table queries instead of a multitable join, and then performing the join in the application. For example, instead of this single query:<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT * FROM tag</span><br><span class="line">    -&gt;    JOIN tag_post ON tag_post.tag_id=tag.id</span><br><span class="line">    -&gt;    JOIN post ON tag_post.post_id=post.id</span><br><span class="line">    -&gt; WHERE tag.tag=&#x27;mysql&#x27;;</span><br></pre></td></tr></table></figure>
You might run these queries:<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT * FROM  tag WHERE tag=&#x27;mysql&#x27;;</span><br><span class="line">mysql&gt; SELECT * FROM  tag_post WHERE tag_id=1234;</span><br><span class="line">mysql&gt; SELECT * FROM  post WHERE  post.id in (123,456,567,9098,8904);</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li>join in the order A, B. Ideally A should be a smaller table.</li>
<li>Have indexes on the columns in the ON clauses. Consider the join order when adding indexes. If you’re joining tables A and B on column c and the query optimizer decides to join the tables in the order B, A, you don’t need to index the column on table B. In general, you need to add indexes only on the second table in the join order, unless they’re needed for some other reason.</li>
</ul>
</li>
<li>group by, order by<ul>
<li>Try to ensure that any GROUP BY or ORDER BY expression refers only to columns from a single table, so MySQL can try to use an index for that operation.</li>
<li>If you need to group a join by a value that comes from a lookup table, it’s usually more efficient to group by the lookup table’s identifier than by the value. For example, the following query isn’t as efficient as it could be:<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT actor.first_name, actor.last_name, COUNT(*)</span><br><span class="line">    -&gt; FROM sakila.film_actor</span><br><span class="line">    -&gt;    INNER JOIN sakila.actor USING(actor_id)</span><br><span class="line">    -&gt; GROUP BY actor.first_name, actor.last_name;</span><br></pre></td></tr></table></figure>
Rewrite:<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">  mysql&gt; SELECT actor.first_name, actor.last_name, COUNT(*)</span><br><span class="line">      -&gt; FROM sakila.film_actor</span><br><span class="line">      -&gt;    INNER JOIN sakila.actor USING(actor_id)</span><br><span class="line">      -&gt; GROUP BY film_actor.actor_id;</span><br><span class="line">  ```    </span><br><span class="line">* limit</span><br><span class="line">- do the offset on a covering index, rather than the full rows. You can then join the result to the full row and retrieve the additional columns you need. Consider the following query:</span><br></pre></td></tr></table></figure>
mysql&gt; SELECT film_id, description FROM sakila.film ORDER BY title LIMIT 50, 5;<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Rewrite:</span><br></pre></td></tr></table></figure>
mysql&gt; SELECT film.film_id, film.description<br>-&gt; FROM sakila.film<br>-&gt;    INNER JOIN (<br>-&gt;       SELECT film_id FROM sakila.film<br>-&gt;       ORDER BY title LIMIT 50, 5<br>-&gt;    ) AS lim USING(film_id);<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Sometimes you can also convert the limit to a positional query, which the server can execute as an index range scan. For example, if you precalculate and index a position column, you can rewrite the query as follows:</span><br></pre></td></tr></table></figure>
mysql&gt; SELECT film_id, description FROM sakila.film<br>-&gt; WHERE position BETWEEN 50 AND 54 ORDER BY position;<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">Another example:</span><br></pre></td></tr></table></figure>
select * from t limit 900000, 10;<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Write:</span><br></pre></td></tr></table></figure>
select * from t<br>where id &gt; 900000<br>limit 10;<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">* replace &quot;or&quot; with &quot;in&quot; or &quot;union&quot;</span><br><span class="line">* in</span><br><span class="line">  - if &quot;in&quot; list is too large, it can be slow. The optimizer will “share” the list by copying it to the corresponding columns in all related tables.  </span><br><span class="line">* batch insert</span><br><span class="line">* min and max</span><br></pre></td></tr></table></figure>
mysql&gt; SELECT MIN(actor_id) FROM sakila.actor WHERE first_name &#x3D; ‘PENELOPE’;<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Because there’s no index on first_name, this query performs a table scan. If MySQL scans the primary key, it can theoretically stop after reading the first matching row, because the primary key is strictly ascending and any subsequent row will have a greater actor_id.</span><br><span class="line">Rewrite:</span><br></pre></td></tr></table></figure>
mysql&gt; SELECT actor_id FROM sakila.actor USE INDEX(PRIMARY)<br>  -&gt; WHERE first_name &#x3D; ‘PENELOPE’ LIMIT 1;<br>&#96;&#96;&#96;</li>
</ul>
</li>
</ul>
<p>Reference: <a target="_blank" rel="noopener" href="https://www.oreilly.com/library/view/high-performance-mysql/9780596101718/ch04.html">https://www.oreilly.com/library/view/high-performance-mysql/9780596101718/ch04.html</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://liamyaolian.github.io/2022/11/04/JWT-vs-Session-Cookie/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Liam Lian">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Liam Lian's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/11/04/JWT-vs-Session-Cookie/" class="post-title-link" itemprop="url">JWT vs Session Cookie</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-11-04 10:41:58 / Modified: 11:33:14" itemprop="dateCreated datePublished" datetime="2022-11-04T10:41:58-04:00">2022-11-04</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="JWT"><a href="#JWT" class="headerlink" title="JWT"></a>JWT</h1><ol>
<li>server authenticates (correct username and password)</li>
<li>server encrypts userId and expiresIn by ACCESS_TOKEN_SECRET to generate access token<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> accessToken =</span><br><span class="line">jwt.<span class="title function_">sign</span>( &#123;userId&#125;, <span class="variable constant_">ACCESS_TOKEN_SECRET</span>, &#123;<span class="attr">expiresIn</span>: <span class="string">&quot;15m&quot;</span>&#125; )</span><br></pre></td></tr></table></figure></li>
<li>server sends access token to browser</li>
<li>browser saves access token</li>
<li>browser sends access token in subsequent requests</li>
<li>server gets access token from request header</li>
<li>server decrypt access token to get user id<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">jwt.<span class="title function_">verify</span>( accessToken, <span class="variable constant_">ACCESS_TOKEN_SECRET</span>, <span class="function">(<span class="params">err, user</span>) =&gt;</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (err) <span class="variable language_">console</span>.<span class="title function_">log</span>(err) <span class="comment">// eg. invalid token, or expired token</span></span><br><span class="line">req.<span class="property">user</span> = user</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></li>
<li>server uses user id to look up persisted data, such as data in shoppingCartDB</li>
</ol>
<ul>
<li>Pro</li>
</ul>
<ul>
<li>No DB call required to get user id, so it’s faster</li>
<li>No need for shared session DB, can horizontally scale</li>
</ul>
<ul>
<li>Con</li>
</ul>
<ul>
<li>after logout, cannot invalidate token immediately</li>
</ul>
<ul>
<li>Anti-pattern</li>
</ul>
<ul>
<li>JWT token should contain user information instead of data authorized</li>
</ul>
<h1 id="Session-Cookie"><a href="#Session-Cookie" class="headerlink" title="Session Cookie"></a>Session Cookie</h1><ol>
<li>server authenticates (correct username and password)</li>
<li>server generates session id (signed with “secret key”)<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">app.<span class="title function_">use</span>( session (&#123; <span class="attr">secret</span>: “secret key”&#125;) )</span><br></pre></td></tr></table></figure></li>
<li>server saves session id in session DB</li>
<li>server sends cookie with session id to browser</li>
<li>browser saves cookie in cookie storage</li>
<li>browser sends cookie in subsequent requests</li>
<li>server gets session id from the request cookie.</li>
<li>server verifies session Id integrity using “secret key” and looks<br>up in session DB to get user id<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">app.<span class="title function_">get</span>(<span class="string">&quot;/&quot;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">   <span class="variable language_">console</span>.<span class="title function_">log</span>(req.<span class="property">session</span>.<span class="property">id</span>)      <span class="comment">// get sessionId</span></span><br><span class="line">   <span class="variable language_">console</span>.<span class="title function_">log</span>(req.<span class="property">session</span>.<span class="property">cookie</span>)  <span class="comment">// get cookie</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></li>
<li>server uses user id to look up persisted data, such as data in shoppingCartDB</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://liamyaolian.github.io/2022/10/30/Principle/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Liam Lian">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Liam Lian's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/10/30/Principle/" class="post-title-link" itemprop="url">Principle</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-10-30 21:17:39 / Modified: 21:24:20" itemprop="dateCreated datePublished" datetime="2022-10-30T21:17:39-04:00">2022-10-30</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <ul>
<li>Dream big before being realistic</li>
<li>Clarify your contextual purpose<ul>
<li>Be sincere to yourself</li>
<li>Make it vivid</li>
</ul>
</li>
<li>Eliminate lesser goals</li>
<li>Knowing and being before doing and having</li>
<li>Ask for exactly what you want</li>
<li>Automate and systemize your future self</li>
<li>Schedule your future self</li>
<li>Aggressively complete imperfect work</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://liamyaolian.github.io/2022/07/08/DRY/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Liam Lian">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Liam Lian's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/07/08/DRY/" class="post-title-link" itemprop="url">DRY</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-07-08 19:47:09" itemprop="dateCreated datePublished" datetime="2022-07-08T19:47:09-04:00">2022-07-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-07-09 09:05:13" itemprop="dateModified" datetime="2022-07-09T09:05:13-04:00">2022-07-09</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>A lot of people think repetitive codes violate the “Don’t Repeat Yourself” principle. However, this is not necessarily true. Below is an example.</p>
<h2 id="Repetitive-Implementation"><a href="#Repetitive-Implementation" class="headerlink" title="Repetitive Implementation"></a>Repetitive Implementation</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserAuthenticator</span> &#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">authenticate</span><span class="params">(String username, String password)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!isValidUsername(username)) &#123;</span><br><span class="line">      <span class="comment">// ...throw InvalidUsernameException...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!isValidPassword(password)) &#123;</span><br><span class="line">      <span class="comment">// ...throw InvalidPasswordException...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//...omit other codes...</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">isValidUsername</span><span class="params">(String username)</span> &#123;</span><br><span class="line">    <span class="comment">// check not null, not empty</span></span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isBlank(username)) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// check length: 4~64</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">length</span> <span class="operator">=</span> username.length();</span><br><span class="line">    <span class="keyword">if</span> (length &lt; <span class="number">4</span> || length &gt; <span class="number">64</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// contains only lowcase characters</span></span><br><span class="line">    <span class="keyword">if</span> (!StringUtils.isAllLowerCase(username)) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// contains only a~z,0~9,dot</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; length; ++i) &#123;</span><br><span class="line">      <span class="type">char</span> <span class="variable">c</span> <span class="operator">=</span> username.charAt(i);</span><br><span class="line">      <span class="keyword">if</span> (!(c &gt;= <span class="string">&#x27;a&#x27;</span> &amp;&amp; c &lt;= <span class="string">&#x27;z&#x27;</span>) || (c &gt;= <span class="string">&#x27;0&#x27;</span> &amp;&amp; c &lt;= <span class="string">&#x27;9&#x27;</span>) || c == <span class="string">&#x27;.&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">isValidPassword</span><span class="params">(String password)</span> &#123;</span><br><span class="line">    <span class="comment">// check not null, not empty</span></span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isBlank(password)) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// check length: 4~64</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">length</span> <span class="operator">=</span> password.length();</span><br><span class="line">    <span class="keyword">if</span> (length &lt; <span class="number">4</span> || length &gt; <span class="number">64</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// contains only lowcase characters</span></span><br><span class="line">    <span class="keyword">if</span> (!StringUtils.isAllLowerCase(password)) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// contains only a~z,0~9,dot</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; length; ++i) &#123;</span><br><span class="line">      <span class="type">char</span> <span class="variable">c</span> <span class="operator">=</span> password.charAt(i);</span><br><span class="line">      <span class="keyword">if</span> (!(c &gt;= <span class="string">&#x27;a&#x27;</span> &amp;&amp; c &lt;= <span class="string">&#x27;z&#x27;</span>) || (c &gt;= <span class="string">&#x27;0&#x27;</span> &amp;&amp; c &lt;= <span class="string">&#x27;9&#x27;</span>) || c == <span class="string">&#x27;.&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>There are repetitive patterns in isValidUsername() and isValidPassword(). Therefore, some people may want to refactor the codes like this:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserAuthenticatorV2</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">authenticate</span><span class="params">(String userName, String password)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!isValidUsernameOrPassword(userName)) &#123;</span><br><span class="line">      <span class="comment">// ...throw InvalidUsernameException...</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!isValidUsernameOrPassword(password)) &#123;</span><br><span class="line">      <span class="comment">// ...throw InvalidPasswordException...</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">isValidUsernameOrPassword</span><span class="params">(String usernameOrPassword)</span> &#123;</span><br><span class="line">    <span class="comment">// omit implementation, which is the same as the implementation in</span></span><br><span class="line">    <span class="comment">// isValidUsername() or isValidPassword() above.</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>If we refactor codes like this, it will be harder to maintain in the future. The reason is that it violates the Single Responsibility Principle.<br>The takeaway here is that having repetitive codes with different functions doesn’t violate DRY.</p>
<h2 id="Repetitive-Function"><a href="#Repetitive-Function" class="headerlink" title="Repetitive Function"></a>Repetitive Function</h2><p>Sometimes even if the implementation of two methods are different, it may still violate DRY.<br>Below is an example:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isValidIp</span><span class="params">(String ipAddress)</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (StringUtils.isBlank(ipAddress)) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  <span class="type">String</span> <span class="variable">regex</span> <span class="operator">=</span> <span class="string">&quot;^(1\\d&#123;2&#125;|2[0-4]\\d|25[0-5]|[1-9]\\d|[1-9])\\.&quot;</span></span><br><span class="line">          + <span class="string">&quot;(1\\d&#123;2&#125;|2[0-4]\\d|25[0-5]|[1-9]\\d|\\d)\\.&quot;</span></span><br><span class="line">          + <span class="string">&quot;(1\\d&#123;2&#125;|2[0-4]\\d|25[0-5]|[1-9]\\d|\\d)\\.&quot;</span></span><br><span class="line">          + <span class="string">&quot;(1\\d&#123;2&#125;|2[0-4]\\d|25[0-5]|[1-9]\\d|\\d)$&quot;</span>;</span><br><span class="line">  <span class="keyword">return</span> ipAddress.matches(regex);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">checkIfIpValid</span><span class="params">(String ipAddress)</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (StringUtils.isBlank(ipAddress)) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  String[] ipUnits = StringUtils.split(ipAddress, <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">  <span class="keyword">if</span> (ipUnits.length != <span class="number">4</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">4</span>; ++i) &#123;</span><br><span class="line">    <span class="type">int</span> ipUnitIntValue;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      ipUnitIntValue = Integer.parseInt(ipUnits[i]);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NumberFormatException e) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (ipUnitIntValue &lt; <span class="number">0</span> || ipUnitIntValue &gt; <span class="number">255</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (i == <span class="number">0</span> &amp;&amp; ipUnitIntValue == <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>These two methods have different implementation but have the same function. If someone use isValidIp somewhere but use checkIfIpValid in other places, it will confuse your colleagues.</p>
<h2 id="Repetitive-Execution"><a href="#Repetitive-Execution" class="headerlink" title="Repetitive Execution"></a>Repetitive Execution</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line">  <span class="keyword">private</span> UserRepo userRepo;<span class="comment">//通过依赖注入或者IOC框架注入</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> User <span class="title function_">login</span><span class="params">(String email, String password)</span> &#123;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">existed</span> <span class="operator">=</span> userRepo.checkIfUserExisted(email, password);</span><br><span class="line">    <span class="keyword">if</span> (!existed) &#123;</span><br><span class="line">      <span class="comment">// ... throw AuthenticationFailureException...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userRepo.getUserByEmail(email);</span><br><span class="line">    <span class="keyword">return</span> user;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserRepo</span> &#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">checkIfUserExisted</span><span class="params">(String email, String password)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!EmailValidation.validate(email)) &#123;</span><br><span class="line">      <span class="comment">// ... throw InvalidEmailException...</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!PasswordValidation.validate(password)) &#123;</span><br><span class="line">      <span class="comment">// ... throw InvalidPasswordException...</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//...query db to check if email&amp;password exists...</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> User <span class="title function_">getUserByEmail</span><span class="params">(String email)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!EmailValidation.validate(email)) &#123;</span><br><span class="line">      <span class="comment">// ... throw InvalidEmailException...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//...query db to get user by email...</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>This code snippet validates email twice, one in checkIfUserExisted(), another in getUserByEmail(), this violates DRY.</p>
<p>The code should be refactored like this:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line">  <span class="keyword">private</span> UserRepo userRepo;<span class="comment">//通过依赖注入或者IOC框架注入</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> User <span class="title function_">login</span><span class="params">(String email, String password)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!EmailValidation.validate(email)) &#123;</span><br><span class="line">      <span class="comment">// ... throw InvalidEmailException...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!PasswordValidation.validate(password)) &#123;</span><br><span class="line">      <span class="comment">// ... throw InvalidPasswordException...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userRepo.getUserByEmail(email);</span><br><span class="line">    <span class="keyword">if</span> (user == <span class="literal">null</span> || !password.equals(user.getPassword()) &#123;</span><br><span class="line">      <span class="comment">// ... throw AuthenticationFailureException...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> user;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserRepo</span> &#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">checkIfUserExisted</span><span class="params">(String email, String password)</span> &#123;</span><br><span class="line">    <span class="comment">//...query db to check if email&amp;password exists</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> User <span class="title function_">getUserByEmail</span><span class="params">(String email)</span> &#123;</span><br><span class="line">    <span class="comment">//...query db to get user by email...</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>In summary, repetitive implementation doesn’t necessarily violate DRY. Repetitive function and repetitive execution violate DRY.                          </p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://liamyaolian.github.io/2022/06/17/MySQL-summary/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Liam Lian">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Liam Lian's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/06/17/MySQL-summary/" class="post-title-link" itemprop="url">MySQL Summary</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-06-17 20:25:28" itemprop="dateCreated datePublished" datetime="2022-06-17T20:25:28-04:00">2022-06-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-11-05 11:35:28" itemprop="dateModified" datetime="2022-11-05T11:35:28-04:00">2022-11-05</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h2><ul>
<li>server layer + storage engine layer<ul>
<li>server layer<ul>
<li>connector: connects client to server</li>
<li>analyzer: lexical and syntax analysis</li>
<li>optimizer: which index to use, which table to be joined first</li>
<li>executor: execute; update binlog in disk</li>
</ul>
</li>
<li>storage engine: read and store, update redo log<ul>
<li>engines</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="Comments"><a href="#Comments" class="headerlink" title="Comments"></a>Comments</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#</span><br><span class="line"><span class="comment">/**/</span></span><br></pre></td></tr></table></figure>
<h2 id="Operator"><a href="#Operator" class="headerlink" title="Operator"></a>Operator</h2><ul>
<li>&lt;&gt;, !&#x3D;</li>
<li>like<ul>
<li>%: &gt;&#x3D; 0</li>
<li>_: 1</li>
</ul>
</li>
<li>regexp: <code>ename regexp &quot;[a-zA-Z]&#123;4&#125;&quot;</code></li>
<li>not, and, or</li>
</ul>
<h2 id="DDL"><a href="#DDL" class="headerlink" title="DDL"></a>DDL</h2><h3 id="Database"><a href="#Database" class="headerlink" title="Database"></a>Database</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">drop database (if exists) database_name;</span><br><span class="line">create database database_name;</span><br><span class="line">show databases;</span><br></pre></td></tr></table></figure>

<h3 id="Table"><a href="#Table" class="headerlink" title="Table"></a>Table</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> (if <span class="keyword">exists</span>) database.table_name;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> database.table_name (                                   </span><br><span class="line">column1 datatype [<span class="keyword">constraint</span>] [comment],                             </span><br><span class="line">column2 datatype [<span class="keyword">constraint</span>] [comment],                             </span><br><span class="line">column3 datatype [<span class="keyword">constraint</span>] [comment],                             </span><br><span class="line">INDEX [ index_name ] ( column_name )                                 </span><br><span class="line"><span class="keyword">foreign</span> key (deptno) <span class="keyword">references</span> t_dept(deptno)                       </span><br><span class="line">....) [comment];                                                     </span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> database.new_table_name                                 </span><br><span class="line"><span class="keyword">AS</span>                                                                   </span><br><span class="line">(<span class="keyword">SELECT</span> column1, column2,...                                         </span><br><span class="line"><span class="keyword">FROM</span> existing_table_name                                             </span><br><span class="line"><span class="keyword">WHERE</span> ....);                                                         </span><br><span class="line"></span><br><span class="line"><span class="keyword">Show</span> tables;  </span><br><span class="line"></span><br><span class="line"><span class="keyword">describe</span> table_name;                                                 </span><br><span class="line"></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> table_name                                               </span><br><span class="line"><span class="keyword">ADD</span> column1 datatype [<span class="keyword">constraint</span>] [COMMENT] ,                        </span><br><span class="line"><span class="keyword">ADD</span> column2 datatype [<span class="keyword">constraint</span>] [COMMENT] ;                        </span><br><span class="line"></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> table_name                                               </span><br><span class="line">MODIFY column1 datatype [<span class="keyword">constraint</span>] [COMMENT] ,                     </span><br><span class="line">MODIFY column2 datatype [<span class="keyword">constraint</span>] [COMMENT] ;                     </span><br><span class="line"></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> table_name                                               </span><br><span class="line">CHANGE column1 new_column_name1 datatype [<span class="keyword">constraint</span>] [COMMENT] ,    </span><br><span class="line">CHANGE column2 new_column_name2 datatype [<span class="keyword">constraint</span>] [COMMENT] ;    </span><br><span class="line"></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> table_name                                               </span><br><span class="line"><span class="keyword">DROP</span> column1 ,                                                       </span><br><span class="line"><span class="keyword">DROP</span> column2 ;                                                       </span><br><span class="line"></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> table_name RENAME new_table_name ;                       </span><br><span class="line">```            </span><br><span class="line"></span><br><span class="line">#### constraints</span><br><span class="line"><span class="operator">*</span> <span class="keyword">PRIMARY</span> KEY</span><br><span class="line"><span class="operator">*</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span></span><br><span class="line"><span class="operator">*</span> <span class="keyword">UNIQUE</span></span><br><span class="line"><span class="operator">*</span> <span class="keyword">FOREIGN</span> KEY           </span><br><span class="line"></span><br><span class="line">### <span class="keyword">Insert</span></span><br><span class="line">```<span class="keyword">SQL</span>                                                                                     </span><br><span class="line"><span class="comment">/*IGNORE: only insert records that do not exist*/</span>                                          </span><br><span class="line"><span class="keyword">INSERT</span> [ IGNORE ] <span class="keyword">INTO</span> table_name [(column1 ,column2, ...)] <span class="keyword">VALUES</span> (value1, value2, ...);  </span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> table_name （column_name）(                                                      </span><br><span class="line"><span class="keyword">SELECT</span> column_name                                                                         </span><br><span class="line"><span class="keyword">FROM</span> table_name                                                                            </span><br><span class="line"><span class="keyword">WHERE</span> 条件);                                                                                 </span><br><span class="line"></span><br><span class="line"><span class="comment">/*MySQL dialect*/</span>                                                                          </span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> table_name <span class="keyword">SET</span> column1<span class="operator">=</span>value1, column2<span class="operator">=</span>value2, ...... ;      </span><br><span class="line"></span><br><span class="line"><span class="comment">/* key: UNIQUE index or PRIMARY KEY */</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> demo.goodsmaster                                          </span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span>                                                              </span><br><span class="line"><span class="keyword">FROM</span> demo.goodsmaster1 <span class="keyword">as</span> a                                           </span><br><span class="line"><span class="keyword">ON</span> DUPLICATE KEY <span class="keyword">UPDATE</span> barcode <span class="operator">=</span> a.barcode, goodsname<span class="operator">=</span>a.goodsname;                      </span><br><span class="line">```        </span><br><span class="line"></span><br><span class="line">### <span class="keyword">Delete</span></span><br><span class="line">```mysql                                                                                         </span><br><span class="line"><span class="comment">/* ignore: if foreign key exists so some records cannot be deleted, will ignore these records  */</span></span><br><span class="line"><span class="keyword">DELETE</span> [ IGNORE ] <span class="keyword">FROM</span> table_name [ <span class="keyword">LEFT</span> <span class="operator">|</span> <span class="keyword">RIGHT</span> ] <span class="keyword">JOIN</span> table_name2 <span class="keyword">ON</span> conditions                </span><br><span class="line"><span class="keyword">WHERE</span> conditions                                                                                 </span><br><span class="line">[ <span class="keyword">ORDER</span> <span class="keyword">BY</span> ... ]                                                                                 </span><br><span class="line">[ LIMIT ... ] ;                                                                                  </span><br><span class="line"></span><br><span class="line"><span class="comment">/*delete all*/</span>                                                                                   </span><br><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> demo.goodsmaster; <span class="operator">/</span><span class="operator">/</span> undo log                                                        </span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> table_name; <span class="operator">/</span><span class="operator">/</span> <span class="keyword">no</span> <span class="keyword">in</span> undo log                                                     </span><br><span class="line">```          </span><br><span class="line"></span><br><span class="line">### <span class="keyword">Update</span></span><br><span class="line">```                                                     </span><br><span class="line"></span><br><span class="line"><span class="keyword">UPDATE</span> table_name   </span><br><span class="line">[<span class="keyword">left</span> <span class="operator">|</span> <span class="keyword">right</span>] <span class="keyword">join</span> table_name2</span><br><span class="line"><span class="keyword">on</span> conditions                                    </span><br><span class="line"><span class="keyword">SET</span> column_name <span class="operator">=</span> <span class="keyword">value</span>                                               </span><br><span class="line"><span class="keyword">WHERE</span> 条件                                                </span><br><span class="line">[ <span class="keyword">ORDER</span> <span class="keyword">BY</span> ... ]                                         </span><br><span class="line">[ LIMIT param ] ; <span class="comment">/*can only have one param*/</span>           </span><br><span class="line">```    </span><br><span class="line"></span><br><span class="line">### Read</span><br><span class="line">```                                    </span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="operator">|</span> [<span class="keyword">DISTINCT</span>] column_name                 </span><br><span class="line"><span class="keyword">FROM</span> table_name                        </span><br><span class="line"><span class="keyword">WHERE</span> conditions                       </span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> column_name                   </span><br><span class="line"><span class="keyword">HAVING</span> conditions                      </span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> column_name                   </span><br><span class="line">LIMIT [<span class="keyword">offset</span>,] row_count                 </span><br></pre></td></tr></table></figure>
<h4 id="Join"><a href="#Join" class="headerlink" title="Join"></a>Join</h4><ul>
<li>inner join</li>
<li>left join, right join<ul>
<li>If there is no match, the columns of the row from the right&#x2F;left table will contain NULL</li>
</ul>
</li>
<li>Full (outer) Join<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM t1                                                                                     </span><br><span class="line">LEFT JOIN t2 ON t1.id = t2.id                                                                        </span><br><span class="line">UNION ALL                                                                                            </span><br><span class="line">SELECT * FROM t1                                                                                     </span><br><span class="line">RIGHT JOIN t2 ON t1.id = t2.id                                                                       </span><br><span class="line">WHERE t1.id IS NULL                                                                                  </span><br><span class="line">```                                                                                                  </span><br><span class="line">* cross join</span><br><span class="line">* self join</span><br><span class="line"></span><br><span class="line">#### Group by</span><br><span class="line">* The number of dimension column you selected can not larger than that of followed by clause group by</span><br><span class="line">* GROUP_CONCAT函数可以把分组查询中的某个字段拼接成一个字符串 // TODO</span><br><span class="line">#### Limit</span><br><span class="line">* `limit 1, 2`: 1 means starting from 1 (included, first row is 0); 2 means returning 2 records</span><br><span class="line">#### aggregation function</span><br><span class="line">* AVG: ignore null, 只能用于数字类型</span><br><span class="line">* COUNT</span><br><span class="line">    - COUNT(*) to count the number of rows in a table</span><br><span class="line">    - COUNT(column) ignores NULL values</span><br><span class="line">* MAX: ignore null</span><br><span class="line">* MIN: ignore null</span><br><span class="line">* SUM: ignore null, 只能用于数字类型</span><br><span class="line">* for each group</span><br><span class="line">* can put `Distinct` inside (), such as `count(DISTINCT prod_price)`</span><br><span class="line">#### Window functions</span><br><span class="line">// TODO</span><br></pre></td></tr></table></figure>
window_function_name(expression) OVER (<br>[PARTITION BY <expression>[{,<expression>…}]]<br>[ORDER BY <expression> [ASC|DESC], [{,<expression>…}]] &#x2F;&#x2F; how the rows are ordered within a partition<br>[frame_unit {<frame_start>|<frame_between>}]<br>)</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line">* frame_unit: row | range</span><br><span class="line">* frame_start</span><br><span class="line">  - UNBOUNDED PRECEDING: frame starts at the first row of the partition.</span><br><span class="line">  - N PRECEDING: a physical N of rows before the first current row.</span><br><span class="line">  - CURRENT ROW</span><br><span class="line">* frame_between: `BETWEEN frame_boundary_1 AND frame_boundary_2`</span><br><span class="line">  - frame_start</span><br><span class="line">  - UNBOUNDED FOLLOWING</span><br><span class="line">  - N FOLLOWING</span><br><span class="line">* default: `RANGE BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW`</span><br><span class="line">* functions</span><br><span class="line">  - Aggregate: Count, Sum, Avg, Min, Max</span><br><span class="line">  - Offset:</span><br><span class="line">    - first_value(column_name)</span><br><span class="line">    - last_value(column_name)</span><br><span class="line">    - lead(&lt;expression&gt;[,offset[, default_value]]): running diff, e.g. y-o-y; If offset is zero, then the LAG() function evaluates the expression for the current row. If you don’t specify the offset, then the LAG() function uses one by default.</span><br><span class="line">    - lag(&lt;expression&gt;[,offset[, default_value]]): running diff, e.g. y-o-y</span><br><span class="line"></span><br><span class="line">  - Rank</span><br><span class="line">    - row_number: Assigns a sequential integer to every row within its partition; application: Removing duplicate rows</span><br><span class="line">    - rank</span><br><span class="line">    - dense_rank   </span><br><span class="line"></span><br><span class="line">### Case when</span><br><span class="line">```sql                                                                                   </span><br><span class="line">CASE WHEN [compare_value] THEN result                                                    </span><br><span class="line">[WHEN [compare_value] THEN result ...]                                                   </span><br><span class="line">[ELSE result] END (AS new_column)                                                        </span><br><span class="line">```                                                                                      </span><br><span class="line">* CASE WHEN case be used in any statement</span><br><span class="line"></span><br><span class="line">### union</span><br><span class="line">* union removes duplicates</span><br><span class="line">* union all</span><br><span class="line">* only one order by statement can be used, which is after the final select statement</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">### Column Alias</span><br><span class="line">* It is not permissible to refer to a column alias in a WHERE clause, because the column value might not yet be determined when the WHERE clause is executed.</span><br><span class="line"></span><br><span class="line">### Table Alias</span><br><span class="line">* derived table must have an alias  </span><br><span class="line"></span><br><span class="line">### function</span><br><span class="line">#### Number</span><br><span class="line">* abs</span><br><span class="line">* round</span><br><span class="line">* floor</span><br><span class="line">* ceil</span><br><span class="line">* power(2,3)</span><br><span class="line">* log(7,3)</span><br><span class="line">* ln(10)</span><br><span class="line">* sqrt(9)</span><br><span class="line">* pi()</span><br><span class="line">* sin</span><br><span class="line">* cos</span><br><span class="line">* tan</span><br><span class="line">* cot</span><br><span class="line">* radians(30): 角度转换弧度</span><br><span class="line">* DEGREES(1): 弧度转换角度   </span><br><span class="line">#### Time</span><br><span class="line">##### system time</span><br><span class="line">* now(): yyyy-MM-dd hh:mm:ss</span><br><span class="line">* curdate(): yyyy-MM-dd</span><br><span class="line">* curtime(): hh:mm:ss        </span><br><span class="line">##### DATE_FORMAT</span><br><span class="line">* DATE_FORMAT(日期, 表达式)      </span><br><span class="line">  %Y 年份                       </span><br><span class="line">  %m 月份                       </span><br><span class="line">  %d 日期                       </span><br><span class="line">  %w 星期(数字)                   </span><br><span class="line">  %W 星期(名称)                   </span><br><span class="line">  %j 本年第几天                    </span><br><span class="line">  %U 本年第几周                    </span><br><span class="line">  %h 小时(12)                   </span><br><span class="line">  %H 小时(24)                   </span><br><span class="line">  %i 分钟                       </span><br><span class="line">  %s 秒                        </span><br><span class="line">  %r 时间(12)                   </span><br><span class="line">  %T 时间(24)               </span><br><span class="line">##### DATE_ADD() and DATEDIFF</span><br><span class="line">* DATE_ADD( 日期 , INTERVAL 15 DAY )</span><br><span class="line">* DATEDIFF ( 日期 , 日期 )</span><br><span class="line">#### String</span><br><span class="line">LOWER                                                                                                                      </span><br><span class="line">UPPER                                                                                                                      </span><br><span class="line">LENGTH                                                                                                                     </span><br><span class="line">SELECT CONCAT(&quot;SQL &quot;, &quot;Tutorial &quot;, &quot;is &quot;, &quot;fun!&quot;) AS ConcatenatedString                                                    </span><br><span class="line">SELECT INSTR(&quot;W3Schools.com&quot;, &quot;3&quot;) AS MatchPosition: 2                                                                     </span><br><span class="line">SELECT INSERT(&quot;W3Schools.com&quot;, 1, 9, &quot;Example&quot;): Example.com                                                               </span><br><span class="line">REPLACE(&quot;你好先生&quot;,&quot;先生&quot;,&quot;女士&quot;)                                                                                                  </span><br><span class="line">SELECT SUBSTR(&quot;SQL Tutorial&quot;, 5, 3) AS ExtractString: Tut                                                                  </span><br><span class="line">SELECT SUBSTRING(&quot;SQL Tutorial&quot;, 5, 3) AS ExtractString: Tut                                                               </span><br><span class="line">SELECT LPAD(&quot;SQL Tutorial&quot;, 20, &quot;ABC&quot;): ABCABCABSQL Tutorial; Left-pad the string with &quot;ABC&quot;, to a total length of 20.     </span><br><span class="line">RPAD(&quot;Hello&quot;,10,&quot;*&quot;)                                                                                                       </span><br><span class="line">TRIM(&quot; 你好先生 &quot;)</span><br><span class="line">#### Condition</span><br><span class="line">IFNULL(expresssion, value)                                                                                                 </span><br><span class="line">IF(expression, value1, value2)    </span><br><span class="line"></span><br><span class="line">### CTE</span><br><span class="line">```sql</span><br><span class="line">WITH RECURSIVE cte_name AS (                                                   </span><br><span class="line">    initial_query  -- anchor member                                            </span><br><span class="line">    UNION ALL                                                                  </span><br><span class="line">    recursive_query -- recursive member that references to the CTE name        </span><br><span class="line">)                                                                              </span><br><span class="line">SELECT * FROM cte_name;                                                        </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>to do: <a target="_blank" rel="noopener" href="https://www.mysqltutorial.org/mysql-recursive-cte/">https://www.mysqltutorial.org/mysql-recursive-cte/</a></p>
<h3 id="subquery"><a href="#subquery" class="headerlink" title="subquery"></a>subquery</h3><ul>
<li>can be in “select”, “from”, “where”</li>
<li>in “from” will have high efficiency, avoid being in “select” or “where”. 查询语句执行的时候要多次的依赖于子查询的结果，这类子查询被<br>称作相关子查询</li>
<li>多行子查询只能出现在WHERE子句和FROM子句中</li>
</ul>
<h3 id="Execution-Order"><a href="#Execution-Order" class="headerlink" title="Execution Order"></a>Execution Order</h3><p>From &gt; join &gt; Where &gt; group by &gt; having &gt; select &gt; distinct &gt; order by &gt; limit                                           </p>
<h2 id="Constraint"><a href="#Constraint" class="headerlink" title="Constraint"></a>Constraint</h2><h3 id="PK-vs-FK"><a href="#PK-vs-FK" class="headerlink" title="PK vs FK"></a>PK vs FK</h3><ul>
<li>PK<ul>
<li>unique</li>
<li>not null</li>
<li>one but can be multiple columns</li>
<li>can use AUTO_INCREMENT</li>
<li>Manual assignment: choose the largest ID, add 1 to make the new ID for the new record<ul>
<li>why: multiple servers, auto_increment will cause duplicates; don’t use business field as PK because the business field may be reused or have duplicates</li>
</ul>
</li>
</ul>
</li>
<li>FK<ul>
<li>primary key in another table</li>
<li>can be null</li>
<li>can have more than one FK</li>
<li>如果形成外键闭环，我们将无法删除任何一张表的记录</li>
</ul>
</li>
</ul>
<h2 id="View"><a href="#View" class="headerlink" title="View"></a>View</h2><ul>
<li>read-only, no storage<br>&#x2F;&#x2F; TODO</li>
</ul>
<h2 id="Log"><a href="#Log" class="headerlink" title="Log"></a>Log</h2><h3 id="General"><a href="#General" class="headerlink" title="General"></a>General</h3><ul>
<li>connection start and end time, all instructions to server   <h3 id="Slow"><a href="#Slow" class="headerlink" title="Slow"></a>Slow</h3></li>
<li>my.ini, restart after modifying my.ini<h3 id="Error"><a href="#Error" class="headerlink" title="Error"></a>Error</h3><h3 id="binary-log-in-the-server-layer"><a href="#binary-log-in-the-server-layer" class="headerlink" title="binary log in the server layer"></a>binary log in the server layer</h3></li>
<li>Has statement-based logging: Events contain SQL statements that produce data changes (inserts, updates, deletes)</li>
<li>append    </li>
<li>for back up<h3 id="Relay-Bin-Log"><a href="#Relay-Bin-Log" class="headerlink" title="Relay Bin Log"></a>Relay Bin Log</h3></li>
<li>on slave server, read bin log from master server and write into  <h3 id="Undo-log"><a href="#Undo-log" class="headerlink" title="Undo log"></a>Undo log</h3></li>
<li>record what data look like before change, allowing rollback and allowing other transactions to read what data look like before it is changed by this transaction</li>
<li>When there are no read-views earlier than this undo log record, it will be deleted.<br><img src="/../image/mysql/2.webp" alt="undo log and read-view"><h3 id="Redo-Log-in-InnoDB"><a href="#Redo-Log-in-InnoDB" class="headerlink" title="Redo Log in InnoDB"></a>Redo Log in InnoDB</h3></li>
<li>used to recover modification of unfinished transaction</li>
<li>Write-ahead logging<ul>
<li>write to redo log, update memory, then disk</li>
<li>when the redo log is full, move to disk to clean some space</li>
</ul>
</li>
</ul>
<p>InnoDB prepares redo log. Executor updates binlog. InnoDB commits redo log.</p>
<h3 id="Lock"><a href="#Lock" class="headerlink" title="Lock"></a>Lock</h3><ul>
<li>行锁是在需要的时候才加上的，等到事务结束时才释放。如果你的事务中需要锁多个行，要把最可能造成锁冲突、最可能影响并发度的锁尽量往后放。</li>
<li>Dead lock<ul>
<li>发起死锁检测（默认innodb_deadlock_detect&#x3D;ON），发现死锁后，InnoDB自动回滚死锁链条中的某一个事务，让其他事务得以继续执行。如果并发能够控制住，比如同一行同时最多只有 10 个线程在更新，那么死锁检测的成本很低</li>
<li>你可以考虑通过将一行改成逻辑上的多行来减少锁冲突。还是以影院账户为例，可以考虑放在多条记录上，比如 10 个记录，影院的账户总额等于这 10 个记录的值的总和。<br>这样每次要给影院账户加金额的时候，随机选其中一条记录来加。这样每次冲突概率变成原来的 1&#x2F;10，可以减少锁等待个数，也就减少了死锁检测的 CPU 消耗。<h3 id="Isolation-Levels"><a href="#Isolation-Levels" class="headerlink" title="Isolation Levels"></a>Isolation Levels</h3></li>
</ul>
</li>
<li>read uncommitted: no read-view.</li>
<li>read committed: a read-view is created when every SQL query of this transaction executes</li>
<li>repeatable read: a read-view is created when the transaction executes a query to operate on the table so the undo log has data, so data seen in this transaction are the same as what they were when this transaction started.</li>
<li>serializable: read and write will add lock. After a transaction finishes, another transaction can execute.<br><img src="/../image/mysql/1.webp" alt="isolation levels"><br>Source: <a target="_blank" rel="noopener" href="https://time.geekbang.org/column/article/68963">https://time.geekbang.org/column/article/68963</a></li>
</ul>
<h2 id="index"><a href="#index" class="headerlink" title="index"></a>index</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CREATE INDEX 索引名 ON table_name( column_name ) ；</span><br><span class="line">ALTER TABLE table_name称 ADD INDEX [ index_name ]( column_name ) ;</span><br><span class="line">SHOW INDEX FROM table_name ;</span><br><span class="line">DROP INDEX index_name ON table_name ;</span><br></pre></td></tr></table></figure>
<ul>
<li>different storage engines may have different index implementation.</li>
<li>Clustered index: defines the physical order in which table records are stored in a database; one clustered index per table; by default is PK</li>
<li>Secondary index</li>
<li>Multiple-column index<ul>
<li>leftmost prefix rule</li>
<li>if filter a field by a range, the field after this field in the multiple-column index will not be filtered by using the multiple-column index any longer.<br>For example, index is (branchnumber, cashiernumber, itemnumber), <code>branchnumber &gt; 10 AND cashiernumber = 1 AND itemnumber = 100</code>: will use index to filter branchnuber,<br>but when filtering cashiernumber, it will not use the index (branchnumber, cashiernumber)</li>
</ul>
</li>
<li>If there are multiple indexes, MySQL will choose the best</li>
<li>Don’t create an index on a big field</li>
</ul>
<h3 id="InnoDB-index-model"><a href="#InnoDB-index-model" class="headerlink" title="InnoDB index model"></a>InnoDB index model</h3><ul>
<li>B+ tree<br><img src="/../image/mysql/3.webp" alt="InnoDB index model"></li>
<li>primary key index (called clustered index in InnoDB): leaves store records</li>
<li>non primary key index (called secondary index in InnoDB): leaves store primary key values. If search based on non primary key index, will search the B+ tree of the non primary key index first, find the primary key value, and then search the B+ tree of the primary key index.</li>
<li>index maintenance<ul>
<li>inserting may cause some records to be moved</li>
<li>if a data page is full, inserting will create a new data page</li>
</ul>
</li>
</ul>
<h2 id="Paradigm"><a href="#Paradigm" class="headerlink" title="Paradigm"></a>Paradigm</h2><ul>
<li>First: atomic: cannot be separated further</li>
<li>Second: every record has a unique identifier; every field depends on the full PK rather than part of PK</li>
<li>Third: cannot have field that depends on non-PK</li>
<li>Business-first: may not obey paradigm 3</li>
</ul>
<h2 id="ER"><a href="#ER" class="headerlink" title="ER"></a>ER</h2><ul>
<li>One entity -&gt; a table</li>
<li>M-N -&gt; a table</li>
</ul>
<h2 id="Stored-Procedure"><a href="#Stored-Procedure" class="headerlink" title="Stored Procedure"></a>Stored Procedure</h2><h3 id="Pro"><a href="#Pro" class="headerlink" title="Pro"></a>Pro</h3><ul>
<li>Performance</li>
</ul>
<ul>
<li>compiled once and stored in executable form and shared among users. quicker and reduce memory requirement.</li>
<li>reduce network round trips</li>
<li>take advantage of the computing resources of the server. For example, you can move computation-bound procedures from client to server</li>
</ul>
<ul>
<li>Reusability</li>
</ul>
<ul>
<li>avoid redundant coding of similar queries</li>
<li>cross applications</li>
</ul>
<ul>
<li>Security and encapsulation</li>
</ul>
<ul>
<li>restrict access<h3 id="Con"><a href="#Con" class="headerlink" title="Con"></a>Con</h3></li>
<li>if changing database, need to change stored procedure</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Liam Lian</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">33</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">5</span>
        <span class="site-state-item-name">categories</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Liam Lian</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
